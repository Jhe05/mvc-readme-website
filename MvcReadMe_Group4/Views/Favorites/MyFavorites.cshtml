@{
	ViewData["Title"] = "My Favorites";
	Layout = "../Shared/_Layout.cshtml";
}

<div class="container">
	<h1 style="color:#fff; margin-bottom:16px;">My Favorites</h1>

	<div id="favorites-root">
		<div id="favorites-loading" style="color:#c9c3e6">Loading favorites...</div>
		<div id="favorites-empty" style="color:#c9c3e6; display:none;">You haven't added any favorites yet.</div>
		<div id="favorites-list" style="display:flex; flex-wrap:wrap; gap:16px;"></div>
	</div>
</div>

<script>
	async function loadFavoritesPage() {
		const loading = document.getElementById('favorites-loading');
		const empty = document.getElementById('favorites-empty');
		const list = document.getElementById('favorites-list');
		loading.style.display = 'block';
		empty.style.display = 'none';
		list.innerHTML = '';

		try {
			const res = await fetch('/Favorites/GetAll', { credentials: 'same-origin' });
			if (!res.ok) {
				const txt = await res.text();
				console.error('GetAll failed', res.status, txt);
				loading.textContent = 'Error loading favorites';
				return;
			}

			const data = await res.json();
			loading.style.display = 'none';
			if (!data.success || !data.favorites || data.favorites.length === 0) {
				empty.style.display = 'block';
				return;
			}

			data.favorites.forEach(f => {
				const card = document.createElement('div');
				card.style.width = '160px';
				card.style.background = 'rgba(40,20,60,0.6)';
				card.style.border = '1px solid rgba(179,136,255,0.08)';
				card.style.borderRadius = '8px';
				card.style.padding = '8px';
				card.style.boxShadow = '0 6px 12px rgba(0,0,0,0.25)';
				card.style.cursor = 'pointer';

				card.innerHTML = `
					<img src="${f.coverImagePath || '/assets/img/default-book-cover.jpg'}" style="width:100%; height:200px; object-fit:cover; border-radius:6px;" />
					<div style="color:#fff; font-weight:600; margin-top:8px; font-size:0.95rem;">${f.title}</div>
					<div style="margin-top:8px;"><a href="/User/BookDetails?id=${f.bookId}" class="btn btn-sm btn-primary">Read Now</a></div>
				`;

				card.addEventListener('click', () => window.location.href = `/User/BookDetails?id=${f.bookId}`);
				list.appendChild(card);
			});

			// Expose functions to allow other pages to update the list live
			window.appendFavorite = function(fav) {
				try {
					// hide empty message
					empty.style.display = 'none';
					const card = document.createElement('div');
					card.style.width = '160px';
					card.style.background = 'rgba(40,20,60,0.6)';
					card.style.border = '1px solid rgba(179,136,255,0.08)';
					card.style.borderRadius = '8px';
					card.style.padding = '8px';
					card.style.boxShadow = '0 6px 12px rgba(0,0,0,0.25)';
					card.style.cursor = 'pointer';
					card.innerHTML = `
						<img src="${fav.coverImagePath || '/assets/img/default-book-cover.jpg'}" style="width:100%; height:200px; object-fit:cover; border-radius:6px;" />
						<div style="color:#fff; font-weight:600; margin-top:8px; font-size:0.95rem;">${fav.title}</div>
						<div style="margin-top:8px;"><a href="/User/BookDetails?id=${fav.bookId}" class="btn btn-sm btn-primary">Read Now</a></div>
					`;
					card.addEventListener('click', () => window.location.href = `/User/BookDetails?id=${fav.bookId}`);
					list.insertBefore(card, list.firstChild);
				} catch (e) { console.error('appendFavorite error', e); }
			};

			window.removeFavorite = function(bookId) {
				try {
					const cards = Array.from(list.children);
					for (const c of cards) {
						if (c.querySelector('a') && c.querySelector('a').getAttribute('href') === `/User/BookDetails?id=${bookId}`) {
							c.remove();
						}
					}
					if (list.children.length === 0) empty.style.display = 'block';
				} catch (e) { console.error('removeFavorite error', e); }
			};

		} catch (err) {
			console.error('Error loading favorites page', err);
			loading.textContent = 'Error loading favorites';
		}
	}

	document.addEventListener('DOMContentLoaded', loadFavoritesPage);
</script>
