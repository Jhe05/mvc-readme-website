@using System.Linq

@{
    ViewData["Title"] = "Dashboard";
    Layout = "~/Views/Shared/_LayoutAdmin.cshtml";
}

<style>
    body {
        background-color: #12001c;
        margin: 0;
        padding: 0;
    }

    .dashboard-container {
        padding: 10px 15px;
        background-color: #12001c; /* very dark purple page background */
    }

    .main-grid {
        display: grid;
        grid-template-columns: 75% 23%;
        gap: 20px;
    }

    .left-column {
        display: flex;
        flex-direction: column;
        gap: 15px;
    }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 12px;
    }

    .stat-card {
        background-color: #24132f; /* dark purple card background */
        border-radius: 11px;
        padding: 14px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4); /* soft dark shadow */
        transition: transform 0.2s ease;
    }

        .stat-card:hover {
            transform: translateY(-5px);
        }

    .stat-icon {
        width: 40px;
        height: 40px;
        border-radius: 9px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 9px;
        font-size: 20px;
    }

        /* Adjusted with purple accent tints */
        .stat-icon.users {
            background-color: #a96be633; /* light purple tint */
            color: #a96be6;
        }

        .stat-icon.books {
            background-color: #c27a1d33; /* keep orange for contrast */
            color: #c27a1d;
        }

        .stat-icon.reads {
            background-color: #7d4bc833; /* medium purple tint */
            color: #7d4bc8;
        }

    .stat-value {
        font-size: 24px;
        font-weight: bold;
        color: #f1e6ff; /* light lavender text */
        margin-bottom: 5px;
    }

    .stat-label {
        color: #d9c9e6; /* soft lavender-gray */
        font-size: 13px;
    }

    .chart-container {
        background-color: #24132f; /* dark purple chart container */
        border-radius: 11px;
        padding: 14px 20px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
        height: 320px;
        margin-bottom: 40px;
        position: relative;
    }

    .chart-wrapper {
        height: calc(100% - 40px);
        position: relative;
    }

    .chart-title {
        color: #f1e6ff;
        font-size: 1.1rem;
        font-weight: 500;
        margin-bottom: 1rem;
    }

    .no-data-message {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        color: #d9c9e6;
        font-size: 1.1rem;
        text-align: center;
        animation: fadeInOut 2s ease-in-out infinite;
    }

    @@keyframes fadeInOut {
        0%, 100% { opacity: 0.5; }
        50% { opacity: 1; }
    }

    .pie-chart-container {
        background-color: #24132f; /* match dark purple cards */
        border-radius: 11px;
        padding: 14px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
        display: flex;
        flex-direction: column;
        height: 47vh;
    }

    .chart-wrapper {
        flex: 1;
        min-height: 0;
        margin-bottom: 14px;
        padding: 9px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

        .chart-wrapper canvas {
            max-width: 90%;
            max-height: 90%;
        }

    .section-title {
        color: #d9c9e6; /* lavender headings */
        font-size: 16px;
        font-weight: 600;
        margin-bottom: 14px;
        padding-bottom: 7px;
        border-bottom: 1px solid #372346; /* subtle purple border */
    }

    .legend-container {
        margin-top: auto;
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 7px 14px;
        padding: 0 9px 9px 9px;
    }

    /* Libroverse-like themed button */
    .libroverse-btn {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        background: linear-gradient(90deg,#ff8a00 0%,#7d4bc8 100%);
        color: #fff;
        border: none;
        padding: 10px 14px;
        border-radius: 10px;
        font-weight: 600;
        box-shadow: 0 8px 20px rgba(125,75,200,0.18);
        transition: transform .12s ease, box-shadow .12s ease, opacity .12s ease;
    }
    .libroverse-btn i { font-size: 1.05rem; }
    .libroverse-btn:hover { transform: translateY(-3px); box-shadow: 0 12px 28px rgba(125,75,200,0.22); opacity: 0.98; }

    .legend-item {
        display: flex;
        align-items: center;
        color: #d9c9e6;
        font-size: 13px;
        margin-bottom: 0;
    }

    .legend-color {
        width: 9px;
        height: 9px;
        border-radius: 50%;
        margin-right: 7px;
        flex-shrink: 0;
    }

    .popular-books-section {
        margin-top: 17px;
    }

    .popular-books-title {
        color: #d9c9e6;
        font-size: 16px;
        font-weight: 600;
        margin-bottom: 14px;
        padding-bottom: 7px;
        border-bottom: 1px solid #372346; /* subtle purple border */
    }

    .popular-books-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 17px;
        padding: 6px 0;
    }

    .book-cover {
        width: 75%;
        aspect-ratio: 2/3;
        object-fit: cover;
        border-radius: 7px;
        transition: transform 0.2s ease, filter 0.2s ease;
        margin: 0 auto;
        display: block;
        filter: brightness(0.9);
    }

        .book-cover:hover {
            transform: translateY(-5px);
            filter: brightness(1);
        }

    @@media (max-width: 1024px) {
        .main-grid {
            grid-template-columns: 1fr;
        }
    {
        grid-template-columns: 1fr;
    }

    .popular-books-grid {
        grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
    }

    }
</style>


<div class="dashboard-container">
    <div class="main-grid">
        <div class="left-column">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon users">
                        <i class="bi bi-people"></i>
                    </div>
                    <div class="stat-value">@ViewBag.TotalUsers</div>
                    <div class="stat-label">Total Users</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon books">
                        <i class="bi bi-book"></i>
                    </div>
                    <div class="stat-value">@ViewBag.TotalBooks</div>
                    <div class="stat-label">Total Books</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon reads">
                        <i class="bi bi-bookmark-check"></i>
                    </div>
                    <div class="stat-value">@ViewBag.TotalReads</div>
                    <div class="stat-label">Total Reads</div>
                </div>
            </div>

            <div class="chart-container">
                <div class="chart-title">Daily Reads (Past Week)</div>
                <div class="chart-wrapper">
                    <canvas id="dailyReadsChart"></canvas>
                    @{
                        var hasData = false;
                        if (ViewBag.DailyReadsCounts != null)
                        {
                            foreach (var count in ViewBag.DailyReadsCounts)
                            {
                                if ((int)count > 0)
                                {
                                    hasData = true;
                                    break;
                                }
                            }
                        }
                        if (!hasData)
                        {
                            <div class="no-data-message">No reading activity recorded in the past week</div>
                        }
                    }
                </div>
            </div>
        </div>

        <div class="right-column">
            <div class="pie-chart-container">
                <div class="section-title">Book Categories</div>
                <!-- Generate Report button moved below categories (styled like Libroverse) -->
                <div class="chart-wrapper">
                    <canvas id="categoryPieChart"></canvas>
                </div>
                <div class="legend-container">
                    @foreach (var category in ViewBag.CategoryDistribution)
                    {
                        <div class="legend-item">
                            <div class="legend-color" style="background-color: @GetCategoryColor(category.Category)"></div>
                            <span>@category.Category (@category.Count)</span>
                        </div>
                    }
                </div>
                <div style="display:flex; justify-content:center; margin-top:14px;">
                    <a class="libroverse-btn" target="_blank" href="http://localhost/php_sql/admin_report.php?mode=today">
                        <i class="bi bi-file-earmark-pdf"></i>
                        <span>Generate Report</span>
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="popular-books-section">
        <div class="popular-books-title">Most Popular Books</div>
        <div class="popular-books-grid">
            @foreach (var book in ViewBag.PopularBooks)
            {
                <img src="@book.CoverImagePath" alt="@book.Title" class="book-cover" title="@book.Title - @book.NumberOfReads reads">
            }
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <script>
        let dailyReadsChart;
        let categoryPieChart;

        // Function to refresh dashboard data
        async function refreshDashboardData() {
            try {
                const response = await fetch('/Admin/GetDashboardData');
                if (!response.ok) throw new Error('Failed to fetch dashboard data');
                const data = await response.json();
                
                // Update statistics
                document.querySelector('.stat-value:nth-child(1)').textContent = data.totalUsers;
                document.querySelector('.stat-value:nth-child(2)').textContent = data.totalBooks;
                document.querySelector('.stat-value:nth-child(3)').textContent = data.totalReads;

                // Update daily reads chart
                dailyReadsChart.data.labels = data.dailyReads.map(d => new Date(d.date).toLocaleDateString('en-US', { weekday: 'short' }));
                dailyReadsChart.data.datasets[0].data = data.dailyReads.map(d => d.count);
                dailyReadsChart.update();

                // Update category distribution
                categoryPieChart.data.labels = data.categoryDistribution.map(c => c.category);
                categoryPieChart.data.datasets[0].data = data.categoryDistribution.map(c => c.count);
                categoryPieChart.update();

                // Update popular books
                const popularBooksGrid = document.querySelector('.popular-books-grid');
                popularBooksGrid.innerHTML = data.popularBooks.map(book => 
                    `<img src="${book.coverImagePath}" alt="${book.title}" class="book-cover" title="${book.title} - ${book.numberOfReads} reads">`
                ).join('');
            } catch (error) {
                console.error('Error refreshing dashboard:', error);
            }
        }

        // Daily Reads Chart
        const dailyReadsCtx = document.getElementById('dailyReadsChart').getContext('2d');
        
        // Create gradient for the fill
        const gradient = dailyReadsCtx.createLinearGradient(0, 0, 0, 300);
        gradient.addColorStop(0, 'rgba(125, 75, 200, 0.25)');  // Purple to match theme
        gradient.addColorStop(1, 'rgba(125, 75, 200, 0.02)');

        const labels = @(Html.Raw(Json.Serialize(ViewBag.DailyReadsLabels ?? new string[0])));
        const data = @(Html.Raw(Json.Serialize(ViewBag.DailyReadsCounts ?? new int[0])));

        dailyReadsChart = new Chart(dailyReadsCtx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Daily Reads',
                    data: data,
                    borderColor: '#7d4bc8',  // Purple to match theme
                    borderWidth: 2.5,
                    backgroundColor: gradient,
                    tension: 0.35,
                    fill: true,
                    pointBackgroundColor: '#7d4bc8',
                    pointBorderColor: '#ffffff',
                    pointBorderWidth: 2,
                    pointRadius: 4,
                    pointHoverRadius: 6,
                    pointHoverBackgroundColor: '#7d4bc8',
                    pointHoverBorderColor: '#ffffff',
                    pointHoverBorderWidth: 2,
                    pointStyle: 'circle'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    intersect: false,
                    mode: 'index'
                },
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        backgroundColor: '#24132f',
                        titleColor: '#f1e6ff',
                        bodyColor: '#d9c9e6',
                        borderColor: '#372346',
                        borderWidth: 1,
                        padding: 12,
                        cornerRadius: 8,
                        displayColors: false,
                        callbacks: {
                            title: function(tooltipItems) {
                                return tooltipItems[0].label;
                            },
                            label: function(context) {
                                const reads = context.raw;
                                return `${reads} ${reads === 1 ? 'Read' : 'Reads'}`;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: {
                            color: '#372346',
                            drawBorder: false,
                            lineWidth: 0.5
                        },
                        ticks: {
                            color: '#d9c9e6',
                            stepSize: 1,
                            font: {
                                size: 12,
                                family: '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif'
                            },
                            padding: 8,
                            callback: function(value) {
                                return value === Math.floor(value) ? value : '';
                            }
                        },
                        border: {
                            display: false
                        }
                    },
                    x: {
                        grid: {
                            display: false
                        },
                        ticks: {
                            color: '#d9c9e6',
                            font: {
                                size: 12,
                                family: '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif'
                            },
                            padding: 8
                        },
                        border: {
                            display: false
                        }
                    }
                },
                animation: {
                    duration: 750,
                    easing: 'easeOutQuart'
                }
            }
        });

        // Category Distribution Pie Chart
        const categoryCtx = document.getElementById('categoryPieChart').getContext('2d');
        const categoryData = @Html.Raw(Json.Serialize(ViewBag.CategoryDistribution));
        
        categoryPieChart = new Chart(categoryCtx, {
            type: 'doughnut',
            data: {
                labels: categoryData.map(c => c.category),
                datasets: [{
                    data: categoryData.map(c => c.count),
                    backgroundColor: categoryData.map(c => getCategoryColor(c.category)),
                    borderWidth: 0,
                    borderRadius: 5,
                    hoverOffset: 15,
                    hoverBorderWidth: 0,
                    spacing: 3
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        backgroundColor: '#1a2029',
                        titleColor: '#ffffff',
                        bodyColor: '#c9d1d9',
                        borderColor: '#2d3748',
                        borderWidth: 1,
                        padding: 12,
                        cornerRadius: 8,
                        displayColors: true,
                        boxPadding: 6,
                        usePointStyle: true,
                        callbacks: {
                            label: function(context) {
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = Math.round((context.raw / total) * 100);
                                return `${context.label}: ${context.raw} (${percentage}%)`;
                            }
                        }
                    }
                },
                cutout: '60%',
                animation: {
                    animateScale: true,
                    animateRotate: true,
                    duration: 1000,
                    easing: 'easeOutQuart'
                }
            }
        });

        // Set up auto-refresh every 5 seconds
        setInterval(refreshDashboardData, 5000);

        function getCategoryColor(category) {
            const colors = {
                'Business': 'rgba(143, 211, 213, 0.9)',    // First color
                'Self-Help': 'rgba(230, 177, 122, 0.9)',   // Second color
                'Fiction': 'rgba(143, 211, 160, 0.9)',     // Third color
                'Programming': 'rgba(183, 148, 244, 0.9)', // Fourth color
                'Non-Fiction': 'rgba(230, 126, 126, 0.9)'  // Fifth color
            };
            return colors[category] || 'rgba(160, 174, 192, 0.9)';
        }
    </script>
}

@functions {
    public string GetCategoryColor(string category)
    {
        var colors = new Dictionary<string, string>
        {
            { "Business", "rgba(143, 211, 213, 0.9)" },    // First color
            { "Self-Help", "rgba(230, 177, 122, 0.9)" },   // Second color
            { "Fiction", "rgba(143, 211, 160, 0.9)" },     // Third color
            { "Programming", "rgba(183, 148, 244, 0.9)" }, // Fourth color
            { "Non-Fiction", "rgba(230, 126, 126, 0.9)" }  // Fifth color
        };
        return colors.ContainsKey(category) ? colors[category] : "rgba(160, 174, 192, 0.9)";
    }
}

